<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ì•¼êµ¬ ì¤‘ê³„ (Live)</title>
    <style>
        /* (ê¸°ë³¸ ìŠ¤íƒ€ì¼) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Malgun Gothic", "ë§‘ì€ ê³ ë”•", helvetica, "Apple SD Gothic Neo", sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 10px auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fff;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .field-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            aspect-ratio: 1 / 0.85;
            background-image: url('https://ssl.pstatic.net/static/sports/resources/live/baseball/ground_base_v6.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        .player-position {
            position: absolute;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            color: #fff;
        }
        .player-position img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #fff;
            background-color: #eee;
        }
        .player-position .name {
            background-color: rgba(0, 0, 0, 0.6);
            padding: 2px 5px;
            border-radius: 4px;
            white-space: nowrap;
        }
        
        #pitcher  { top: 40.5%; left: 50%; transform: translateX(-50%); }
        #catcher  { top: 82%; left: 50%; transform: translateX(-50%); }
        #batter   { top: 68%; left: 70%; transform: translateX(-50%); }
        #pos-1b   { top: 43%; left: 81%; }
        #pos-2b   { top: 22%; left: 69%; }
        #pos-3b   { top: 43%; left: 19%; }
        #pos-ss   { top: 22%; left: 31%; }
        #pos-lf   { top: 10%; left: 15%; }
        #pos-cf   { top: 5%;  left: 50%; transform: translateX(-50%); }
        #pos-rf   { top: 10%; left: 85%; }

        #scoreboard {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 6px;
            padding: 10px;
            color: white;
            font-weight: bold;
        }
        .team-score { display: flex; align-items: center; font-size: 18px; line-height: 1.5; }
        .team-score img { width: 24px; height: 24px; margin-right: 8px; }
        
        #bso-box {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 6px;
            padding: 10px;
            color: white;
            font-size: 14px;
        }
        .bso-lights { display: flex; gap: 4px; margin-top: 5px; }
        .bso-lights > div { font-weight: bold; width: 10px; }
        .bso-lights .light {
            width: 12px; height: 12px; border-radius: 50%;
            background-color: #555;
            border: 1px solid #888;
        }
        .bso-lights .light.on { background-color: #f00; }
        #ball-lights .light.on { background-color: #0f0; }
        #strike-lights .light.on { background-color: #ff0; }

        #on-deck {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            font-size: 14px;
        }
        #on-deck h4 { margin: 0 0 5px 0; font-size: 12px; color: #ccc; }
        #on-deck ul { list-style: none; margin: 0; padding: 0; }
        
        .info-container {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
        }
        .inning-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .player-card {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .player-card img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 12px;
            background-color: #f0f0f0;
        }
        .player-info .name { font-size: 16px; font-weight: bold; }
        .player-info .position { font-size: 12px; color: #666; margin-left: 5px; }
        .player-stats { font-size: 12px; color: #555; margin-top: 5px; }
        .player-stats span { margin-right: 10px; }
        .player-stats span strong { color: #000; }
        
        .update-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #888;
            padding: 0 15px 10px;
        }
        #error-log {
            color: #d93025;
            font-weight: bold;
        }

        #pitch-by-pitch-list {
            padding: 10px 15px;
            font-size: 14px;
            background-color: #f9f9f9;
            border-radius: 4px;
            min-height: 100px;
        }
        #pitch-by-pitch-list div {
            padding: 2px 0;
            border-bottom: 1px dashed #eee;
        }
        #pitch-by-pitch-list div:last-child { border: none; }
        #pitch-by-pitch-list .change {
            color: #007aff;
            font-weight: bold;
            margin: 5px 0;
        }

        /* [ âš¾ 2. ì•Œë¦¼ ë°°ë„ˆ CSS ì¶”ê°€ âš¾ ] */
        #event-notification-banner {
            padding: 12px 15px;
            margin-bottom: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            /* ë†’ì´ê°€ ë³€í•˜ì§€ ì•Šë„ë¡ ìµœì†Œ ë†’ì´ ì„¤ì • */
            min-height: 1.2em; 
            /* ë¶€ë“œëŸ¬ìš´ ìƒ‰ìƒ ì „í™˜ íš¨ê³¼ */
            transition: background-color 0.3s ease, color 0.3s ease; 
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="field-container">
            <div id="scoreboard">
                <div class="team-score">
                    <img id="away-logo" src="">
                    <span id="away-name">---</span>
                    <span id="away-score" style="margin-left: 10px;">0</span>
                </div>
                <div class="team-score">
                    <img id="home-logo" src="">
                    <span id="home-name">---</span>
                    <span id="home-score" style="margin-left: 10px;">0</span>
                </div>
            </div>

            <div id="bso-box">
                <div id="inning" style="font-weight: bold; text-align: center;">-íšŒ-</div>
                <div class="bso-lights">
                    <div>B</div>
                    <div id="ball-lights" style="display: flex; gap: 4px;">
                        <div class="light"></div><div class="light"></div><div class="light"></div><div class="light"></div>
                    </div>
                </div>
                <div class="bso-lights">
                    <div>S</div>
                    <div id="strike-lights" style="display: flex; gap: 4px;">
                        <div class="light"></div><div class="light"></div><div class="light"></div>
                    </div>
                </div>
                <div class="bso-lights">
                    <div>O</div>
                    <div id="out-lights" style="display: flex; gap: 4px;">
                        <div class="light"></div><div class="light"></div><div class="light"></div>
                    </div>
                </div>
                <div id="current-pitcher-name" style="text-align: center; margin-top: 5px; font-size: 12px;"></div>
            </div>

            <div id="on-deck">
                <h4>ëŒ€ê¸°íƒ€ì„</h4>
                <ul id="on-deck-list"></ul>
            </div>

            <div id="player-positions">
                <div id="pitcher" class="player-position"><img src="" alt="íˆ¬ìˆ˜"><span class="name">---</span></div>
                <div id="catcher" class="player-position"><img src="" alt="í¬ìˆ˜"><span class="name">---</span></div>
                <div id="pos-1b" class="player-position"><img src="" alt="1ë£¨ìˆ˜"><span class="name">---</span></div>
                <div id="pos-2b" class="player-position"><img src="" alt="2ë£¨ìˆ˜"><span class="name">---</span></div>
                <div id="pos-3b" class="player-position"><img src="" alt="3ë£¨ìˆ˜"><span class="name">---</span></div>
                <div id="pos-ss" class="player-position"><img src="" alt="ìœ ê²©ìˆ˜"><span class="name">---</span></div>
                <div id="pos-lf" class="player-position"><img src="" alt="ì¢Œìµìˆ˜"><span class="name">---</span></div>
                <div id="pos-cf" class="player-position"><img src="" alt="ì¤‘ê²¬ìˆ˜"><span class="name">---</span></div>
                <div id="pos-rf" class="player-position"><img src="" alt="ìš°ìµìˆ˜"><span class="name">---</span></div>
                <div id="batter" class="player-position"><img src="" alt="íƒ€ì"><span class="name">---</span></div>
            </div>
        </div>

        <div class="update-info">
            <span id="error-log"></span>
            <span>ìë™ ì—…ë°ì´íŠ¸ <strong id="countdown" style="color: #000;">10</strong>ì´ˆ í›„</span>
        </div>
        <div class="info-container">
            
            <div id="event-notification-banner"></div>
            
            <div id="inning-title" class="inning-title">ë°ì´í„° ë¡œë“œ ì¤‘...</div>

            <div class="player-card" id="pitcher-card">
                <img id="p-img" src="">
                <div class="player-info">
                    <div><span id="p-name" class="name">---</span><span id="p-pos" class="position">íˆ¬ìˆ˜</span></div>
                    <div id="p-stats" class="player-stats"></div>
                </div>
            </div>

            <div class="player-card" id="batter-card">
                <img id="b-img" src="">
                <div class="player-info">
                    <div><span id="b-name" class="name">---</span><span id="b-pos" class="position">íƒ€ì</span></div>
                    <div id="b-stats" class="player-stats"></div>
                </div>
            </div>
            
            <div id="pitch-by-pitch-list"></div>
        </div>
    </div>

    <script>
        let currentInning = 1;
        // ì´ì „ì— ì²˜ë¦¬í•œ ê°€ì¥ ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ì˜ ìˆœë²ˆ(seqno)
        let lastProcessedSeqNo = 0; 

        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
            startCountdown();
        });

        async function fetchData() {
            const url = `http://localhost:3000/api/relay?inning=${currentInning}`;
            const requestUrl = url; 
            
            document.getElementById('error-log').textContent = '';

            try {
                const response = await fetch(requestUrl); 
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                if (!data.success) throw new Error(data.message || 'APIì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                
                updateUI(data.result);

            } catch (error) {
                console.error('ì‹¤ì‹œê°„ ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
                document.getElementById('error-log').textContent = `ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
            }
        }

        // 2. ë°ì´í„°ë¥¼ HTMLì— ì ìš©í•˜ê¸°
        function updateUI(result) {
            if (!result || !result.game || !result.textRelayData) {
                document.getElementById('inning-title').textContent = "ê²½ê¸°ê°€ ì¢…ë£Œë˜ì—ˆê±°ë‚˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }
            
            const game = result.game;
            const data = result.textRelayData;
            const state = data.currentGameState;

            // [ âš¾ 3. ì´ë²¤íŠ¸ ê°ì§€ ë¡œì§ ìˆ˜ì • âš¾ ]
            try {
                const relays = data.textRelayData.textRelays;
                let latestEvent = null; // ì´ë²ˆì— ë¡œë“œí•œ ë°ì´í„° ì¤‘ ê°€ì¥ ìµœì‹  "í”Œë ˆì´"
                let currentMaxSeqNo = lastProcessedSeqNo;

                // 1. ëª¨ë“  íƒ€ì„(relays)ê³¼ ëª¨ë“  í”Œë ˆì´(textOptions)ë¥¼ ìˆœíšŒ
                for (const atBat of relays) {
                    for (const play of atBat.textOptions) {
                        const seqNo = play.seqno;
                        
                        // 2. "í”Œë ˆì´"ì— í•´ë‹¹í•˜ëŠ” íƒ€ì…(1, 13, 23)ì¸ì§€ í™•ì¸
                        if (play.type === 1 || play.type === 13 || play.type === 23) {
                            // 3. í˜„ì¬ê¹Œì§€ ì°¾ì€ ìµœì‹  ì´ë²¤íŠ¸ë³´ë‹¤ ë” ìµœì‹ ì¸ì§€ í™•ì¸
                            if (!latestEvent || seqNo > latestEvent.seqno) {
                                latestEvent = play;
                            }
                        }
                        
                        // 4. ì´ë²ˆì— ë¡œë“œí•œ ëª¨ë“  ì´ë²¤íŠ¸ ì¤‘ ê°€ì¥ í° seqnoë¥¼ ì°¾ìŒ (ë‹¤ìŒ ìš”ì²­ì„ ìœ„í•´)
                        if (seqNo > currentMaxSeqNo) {
                            currentMaxSeqNo = seqNo;
                        }
                    }
                }

                // 5. ì•Œë¦¼ ë°°ë„ˆ DOM ìš”ì†Œë¥¼ ì°¾ìŒ
                const banner = document.getElementById('event-notification-banner');

                // 6. ê°€ì¥ ìµœì‹  "í”Œë ˆì´"ê°€ ìˆê³ , ì´ì „ì— ì²˜ë¦¬í•œ "í”Œë ˆì´"ê°€ ì•„ë‹ ê²½ìš°
                if (latestEvent && latestEvent.seqno > lastProcessedSeqNo) {
                    const playText = latestEvent.text;

                    // 7. í™ˆëŸ° (type: 23)
                    if (latestEvent.type === 23 && playText.includes('í™ˆëŸ°')) {
                        banner.textContent = `âš¾ ${playText} âš¾`;
                        banner.style.backgroundColor = '#FFF1F0';
                        banner.style.color = '#D93025';
                    } 
                    // 8. ì•ˆíƒ€/Në£¨íƒ€ (type: 13)
                    else if (latestEvent.type === 13 && (playText.includes('ì•ˆíƒ€') || playText.includes('ë£¨íƒ€'))) {
                        banner.textContent = `ğŸ”¥ ${playText} ğŸ”¥`;
                        banner.style.backgroundColor = '#E8F0FE';
                        banner.style.color = '#1A73E8';
                    }
                    // 9. 'ë³¼' (type: 1) ê°ì§€
                    else if (latestEvent.type === 1 && playText.includes('ë³¼')) {
                        banner.textContent = `ğŸ”µ ${playText} ğŸ”µ`;
                        banner.style.backgroundColor = '#E6F4EA';
                        banner.style.color = '#34A853';
                    }
                    // 10. (ë³´ë„ˆìŠ¤) ìŠ¤íŠ¸ë¼ì´í¬/í—›ìŠ¤ìœ™ ê°ì§€
                    else if (latestEvent.type === 1 && (playText.includes('ìŠ¤íŠ¸ë¼ì´í¬') || playText.includes('í—›ìŠ¤ìœ™') || playText.includes('íŒŒìš¸'))) {
                        banner.textContent = `ğŸŸ¡ ${playText} ğŸŸ¡`;
                        banner.style.backgroundColor = '#FFF8E1';
                        banner.style.color = '#FAA91A';
                    }
                    // 11. (ë³´ë„ˆìŠ¤) ì•„ì›ƒ ê°ì§€
                    else if (latestEvent.type === 13 && (playText.includes('ì•„ì›ƒ') || playText.includes('ì‚¼ì§„'))) {
                         banner.textContent = `âšª ${playText} âšª`;
                         banner.style.backgroundColor = '#F1F3F4';
                         banner.style.color = '#5F6368';
                    }
                    // 12. ê·¸ ì™¸ì˜ ê²½ìš°ëŠ” ë°°ë„ˆ ë¹„ìš°ê¸°
                    else {
                        banner.textContent = '';
                        banner.style.backgroundColor = '#f0f0f0';
                        banner.style.color = '#333';
                    }
                }
                
                // 13. ë§ˆì§€ë§‰ìœ¼ë¡œ ì²˜ë¦¬í•œ seqnoë¥¼ ê°±ì‹ 
                lastProcessedSeqNo = currentMaxSeqNo;

            } catch (e) {
                console.error("ì´ë²¤íŠ¸ ê°ì§€ ì¤‘ ì˜¤ë¥˜:", e);
            }
            // --- ì´ë²¤íŠ¸ ê°ì§€ ë¡œì§ ë ---


            // --- (ê¸°ì¡´ UI ì—…ë°ì´íŠ¸ ë¡œì§) ---

            function getPlayerByPcode(lineup, pcode) {
                if (!lineup) return {};
                return lineup.find(p => p.pcode === pcode) || {};
            }
            
            currentInning = data.inn;

            document.getElementById('away-logo').src = game.awayTeamEmblemUrl;
            document.getElementById('away-name').textContent = game.awayTeamShortName;
            document.getElementById('away-score').textContent = state.awayScore;
            
            document.getElementById('home-logo').src = game.homeTeamEmblemUrl;
            document.getElementById('home-name').textContent = game.homeTeamShortName;
            document.getElementById('home-score').textContent = state.homeScore;

            document.getElementById('inning').textContent = game.statusInfo;
            
            updateLights('ball-lights', parseInt(state.ball));
            updateLights('strike-lights', parseInt(state.strike));
            updateLights('out-lights', parseInt(state.out));
            
            const isHomeAttack = (data.homeOrAway === "1");
            const defenseLineup = isHomeAttack ? data.awayLineup : data.homeLineup;
            const attackLineup = isHomeAttack ? data.homeLineup : data.awayLineup;

            const pitcher = getPlayerByPcode(defenseLineup.pitcher, state.pitcher);
            const batter = getPlayerByPcode(attackLineup.batter, state.batter);

            document.getElementById('current-pitcher-name').textContent = pitcher.name || '---';
            document.getElementById('p-name').textContent = pitcher.name || '---';
            document.getElementById('p-pos').textContent = `íˆ¬ìˆ˜(${pitcher.hitType || '---'})`;
            document.getElementById('p-stats').innerHTML = `
                <span>ì´ë‹ <strong>${pitcher.inn || 0.0}</strong></span>
                <span>íƒˆì‚¼ì§„ <strong>${pitcher.kk || 0}</strong></span>
                <span>ì‹¤ì  <strong>${pitcher.run || 0}</strong></span>
                <span>í”¼ì•ˆíƒ€ <strong>${pitcher.hit || 0}</strong></span>
                <span>íˆ¬êµ¬ìˆ˜ <strong>${pitcher.ballCount || 0}</strong></span>`;
            
            document.getElementById('b-name').textContent = batter.name || '---';
            document.getElementById('b-pos').textContent = `${batter.batOrder}ë²ˆíƒ€ì(${batter.hitType || '---'})`;
            document.getElementById('b-stats').innerHTML = `
                <span>íƒ€ìœ¨ <strong>${batter.todayHra || 0.000}</strong></span>
                <span>íƒ€ì„ <strong>${batter.pa || 0}</strong></span>
                <span>íƒ€ìˆ˜ <strong>${batter.ab || 0}</strong></span>
                <span>ì•ˆíƒ€ <strong>${batter.hit || 0}</strong></span>
                <span>í™ˆëŸ° <strong>${batter.hr || 0}</strong></span>
                <span>ë³¼ë„· <strong>${batter.bb || 0}</strong></span>`;

            const defense = {};
            if (defenseLineup && defenseLineup.batter) {
                defenseLineup.batter.forEach(p => {
                    if (!p.cout) { 
                        defense[p.pos] = p.name;
                    }
                });
            }
            
            updatePlayerPos('pitcher', pitcher.name);
            updatePlayerPos('catcher', defense[2]);
            updatePlayerPos('pos-1b', defense[3]);
            updatePlayerPos('pos-2b', defense[4]);
            updatePlayerPos('pos-3b', defense[5]);
            updatePlayerPos('pos-ss', defense[6]);
            updatePlayerPos('pos-lf', defense[7]);
            updatePlayerPos('pos-cf', defense[8]);
            updatePlayerPos('pos-rf', defense[9]);
            updatePlayerPos('batter', batter.name);

            const onDeckList = document.getElementById('on-deck-list');
            onDeckList.innerHTML = '';
            
            if (attackLineup && attackLineup.batter) {
                const currentBatOrder = batter.batOrder;
                const lineup = attackLineup.batter.filter(p => !p.cout);
                
                let currentIndex = lineup.findIndex(p => p.batOrder === currentBatOrder);
                if (currentIndex !== -1) {
                    for (let i = 1; i <= 3; i++) {
                        let nextIndex = (currentIndex + i) % lineup.length;
                        let nextBatter = lineup[nextIndex];
                        if(nextBatter) {
                            const li = document.createElement('li');
                            li.textContent = `${nextBatter.batOrder}.${nextBatter.name}`;
                            onDeckList.appendChild(li);
                        }
                    }
                }
            }

            const pbpList = document.getElementById('pitch-by-pitch-list');
            pbpList.innerHTML = ''; 
            
            const currentAtBatRelay = data.textRelays.find(r => r.no === data.no);
            if (currentAtBatRelay) {
                document.getElementById('inning-title').textContent = `${data.inn}íšŒ${isHomeAttack ? 'ë§' : 'ì´ˆ'} - ${isHomeAttack ? game.homeTeamName : game.awayTeamName} ê³µê²©`;
                
                currentAtBatRelay.textOptions.slice().reverse().forEach(p => {
                    const div = document.createElement('div');
                    if (p.type === 1 || p.type === 13) {
                        div.textContent = p.text;
                    } else if (p.type === 2 && p.playerChange) {
                        div.textContent = `ğŸ”„ ${p.playerChange.liveText}`;
                        div.className = 'change';
                    }
                    if (div.textContent) {
                        pbpList.appendChild(div);
                    }
                });
            }
        }

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
        function updateLights(elementId, count) {
            const lights = document.querySelectorAll(`#${elementId} .light`);
            lights.forEach((light, index) => {
                light.classList.toggle('on', index < count);
            });
        }
        
        function updatePlayerPos(elementId, name) {
            const el = document.getElementById(elementId);
            if (el) {
                el.querySelector('.name').textContent = name || '---';
            }
        }

        function startCountdown() {
            let seconds = 10;
            const countdownEl = document.getElementById('countdown');
            
            setInterval(() => {
                seconds--;
                if (seconds <= 0) {
                    seconds = 10;
                    fetchData(); // 10ì´ˆë§ˆë‹¤ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                }
                countdownEl.textContent = seconds;
            }, 1000);
        }
    </script>

</body>
</html>